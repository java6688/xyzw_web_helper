name: CD Deploy

on:
  workflow_run:
    workflows: ['CI Code Checks']
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: corepack enable
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter ./apps/app_1 build
      - run: pnpm --filter ./apps/app_2 build
      - name: Validate SFTP variables and secret
        run: |
          if [ -z "${{ vars.SFTP_HOST }}" ]; then echo "::error::SFTP_HOST variable not set"; exit 1; fi
          if [ -z "${{ vars.SFTP_USERNAME }}" ]; then echo "::error::SFTP_USERNAME variable not set"; exit 1; fi
          if [ -z "${{ secrets.SFTP_PASSWORD }}" ]; then echo "::error::SFTP_PASSWORD secret not set"; exit 1; fi
          if [ -z "${{ vars.SFTP_PORT }}" ]; then echo "::error::SFTP_PORT variable not set"; exit 1; fi
          if [ -z "${{ vars.SFTP_APP1_DIR }}" ]; then echo "::error::SFTP_APP1_DIR variable not set"; exit 1; fi
          if [ -z "${{ vars.SFTP_APP2_DIR }}" ]; then echo "::error::SFTP_APP2_DIR variable not set"; exit 1; fi
          APP1_DIR="${{ vars.SFTP_APP1_DIR }}"
          APP2_DIR="${{ vars.SFTP_APP2_DIR }}"
          case "$APP1_DIR" in */) ;; *) APP1_DIR="$APP1_DIR/";; esac
          case "$APP2_DIR" in */) ;; *) APP2_DIR="$APP2_DIR/";; esac
          echo "APP1_DIR=$APP1_DIR" >> $GITHUB_ENV
          echo "APP2_DIR=$APP2_DIR" >> $GITHUB_ENV
      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
      - name: Upload app_1 (SFTP mirror, skip existing)
        run: |
          lftp -u "${{ vars.SFTP_USERNAME }}","${{ secrets.SFTP_PASSWORD }}" -p ${{ vars.SFTP_PORT }} sftp://${{ vars.SFTP_HOST }} -e "set sftp:auto-confirm yes; set net:timeout 30; set net:max-retries 2; mkdir -p $APP1_DIR; mirror -R -n apps/app_1/dist/ $APP1_DIR; bye"
        env:
          APP1_DIR: ${{ env.APP1_DIR }}
      - name: Upload app_2 (SFTP mirror, skip existing)
        run: |
          lftp -u "${{ vars.SFTP_USERNAME }}","${{ secrets.SFTP_PASSWORD }}" -p ${{ vars.SFTP_PORT }} sftp://${{ vars.SFTP_HOST }} -e "set sftp:auto-confirm yes; set net:timeout 30; set net:max-retries 2; mkdir -p $APP2_DIR; mirror -R -n apps/app_2/dist/ $APP2_DIR; bye"
        env:
          APP2_DIR: ${{ env.APP2_DIR }}
